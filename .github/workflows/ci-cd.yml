name: Python CI/CD
on:
  push:
    branches: [ main ]

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run tests
        run: pytest

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        run: docker build -t mon-python-app .

      - name: Install Kompose
        run: |
          curl -L https://github.com/kubernetes/kompose/releases/download/v1.26.1/kompose-linux-amd64 -o kompose
          chmod +x kompose
          sudo mv kompose /usr/local/bin/

      - name: Generate Kubernetes manifests
        run: kompose convert -f docker-compose.yml

      - name: Create PVC
        run: |
          cat <<EOF > python-app-pvc.yaml
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: python-app-pvc
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 5Gi
          EOF

      - name: Mount PVC in Deployment
        run: |
          sudo apt-get update && sudo apt-get install -y jq yq
          yq eval '.spec.template.spec.containers[0].volumeMounts += [{"mountPath": "/app/data","name": "python-app-storage"}]' -i python-app-deployment.yaml
          yq eval '.spec.template.spec.volumes += [{"name": "python-app-storage","persistentVolumeClaim":{"claimName":"python-app-pvc"}}]' -i python-app-deployment.yaml

      - name: Zip manifests
        run: |
          mkdir KayeZabdielPython
          mv python-app-deployment.yaml python-app-service.yaml python-app-pvc.yaml KayeZabdielPython/
          zip -r KayeZabdielPython.zip KayeZabdielPython

      - name: Upload ZIP to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4
        with:
          server: ftp.cluster114.hosting.ovh.net
          username: ludivinej
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./KayeZabdielPython.zip
          remote-dir: /RenduDevopsKube/
